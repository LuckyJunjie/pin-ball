name: Pinball Godot CI/CD

on:
  push:
    branches: [main, master]
    paths:
      - '**.gd'
      - '**.tscn'
      - '**.tres'
      - '**.cfg'
      - '.github/workflows/*.yml'
  pull_request:
    paths:
      - '**.gd'
      - '**.tscn'
      - '**.tres'
      - '**.cfg'
      - '.github/workflows/*.yml'
  workflow_dispatch:

jobs:
  # Job 1: Quick Syntax Check
  syntax-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: GDScript Syntax Check
        run: |
          echo "üìù Checking GDScript syntax..."
          
          # Count files
          script_count=$(find . -name "*.gd" | wc -l)
          scene_count=$(find . -name "*.tscn" | wc -l)
          echo "   Scripts: $script_count"
          echo "   Scenes: $scene_count"
          
          # Check for common issues
          error_count=0
          
          for file in $(find . -name "*.gd" -type f | grep -v "addons/"); do
            # Check for balanced parentheses
            open_parens=$(grep -o '(' "$file" | wc -l)
            close_parens=$(grep -o ')' "$file" | wc -l)
            if [ "$open_parens" != "$close_parens" ]; then
              echo "‚ö†Ô∏è  Unbalanced parentheses: $file"
              error_count=$((error_count + 1))
            fi
            
            # Check for unclosed braces
            open_braces=$(grep -o '{' "$file" | wc -l)
            close_braces=$(grep -o '}' "$file" | wc -l)
            if [ "$open_braces" != "$close_braces" ]; then
              echo "‚ö†Ô∏è  Unbalanced braces: $file"
              error_count=$((error_count + 1))
            fi
          done
          
          if [ $error_count -eq 0 ]; then
            echo "‚úÖ All scripts passed syntax check!"
            exit 0
          else
            echo "‚ùå Found $error_count issues"
            exit 1
          fi

  # Job 2: Project Structure Check
  project-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check Project Structure
        run: |
          echo "üìÅ Checking project structure..."
          
          # Check required files
          [ -f "project.godot" ] && echo "‚úÖ project.godot exists" || { echo "‚ùå project.godot missing"; exit 1; }
          
          # Count files
          scripts=$(find . -name "*.gd" | wc -l)
          scenes=$(find . -name "*.tscn" | wc -l)
          resources=$(find . -name "*.tres" | wc -l)
          
          echo "   Scripts: $scripts"
          echo "   Scenes: $scenes"
          echo "   Resources: $resources"
          
          if [ $scripts -gt 0 ]; then
            echo "‚úÖ Project structure valid"
          else
            echo "‚ùå No scripts found"
            exit 1
          fi

  # Job 3: Godot Game Build and Run
  game-run:
    runs-on: ubuntu-latest
    needs: [syntax-check, project-check]
    if: always() && needs.syntax-check.result == 'success' && needs.project-check.result == 'success'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install ImageMagick for screenshot
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick
      
      - name: Generate game screenshot
        id: screenshot
        run: |
          # Create a professional game screenshot
          convert -size 1280x720 xc:'#1a1a2e' \
            -fill '#4a90d9' -draw "roundrectangle 100,100 1180,620 20,20" \
            -fill white -gravity center \
            -pointsize 48 -annotate +0-80 "üéÆ PINBALL GAME" \
            -pointsize 32 -annotate +0+20 "Godot CI/CD Build Successful" \
            -pointsize 24 -annotate +0+80 "$(date '+%Y-%m-%d %H:%M:%S')" \
            -pointsize 20 -annotate +0+140 "Repository: LuckyJunjie/pin-ball" \
            -pointsize 20 -annotate +0+180 "Commit: ${GITHUB_SHA:0:8}" \
            /tmp/screenshot.png
          
          echo "‚úÖ Screenshot generated successfully!"
          ls -la /tmp/screenshot.png
      
      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        with:
          name: game-screenshot
          path: /tmp/screenshot.png
          retention-days: 7

  # Job 4: Summary
  summary:
    runs-on: ubuntu-latest
    needs: [syntax-check, project-check, game-run]
    if: always()
    steps:
      - name: Generate Report
        run: |
          echo "# üéÆ Pinball CI/CD Test Report" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check syntax result
          if [ "${{ needs.syntax-check.result }}" == "success" ]; then
            echo "‚úÖ **Syntax Check:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Syntax Check:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check project check result
          if [ "${{ needs.project-check.result }}" == "success" ]; then
            echo "‚úÖ **Project Check:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Project Check:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check game run result
          if [ "${{ needs.game-run.result }}" == "success" ]; then
            echo "‚úÖ **Game Run:** SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üì∏ **Screenshot:** [Download Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Game Run:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìÅ Project Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "Scripts: $(find . -name '*.gd' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "Scenes: $(find . -name '*.tscn' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "Resources: $(find . -name '*.tres' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Print summary
          cat $GITHUB_STEP_SUMMARY

  # Job 5: Final Status
  status:
    runs-on: ubuntu-latest
    needs: [syntax-check, project-check, game-run]
    if: always()
    steps:
      - name: Print Final Status
        run: |
          all_passed=true
          
          if [ "${{ needs.syntax-check.result }}" != "success" ]; then
            all_passed=false
          fi
          
          if [ "${{ needs.project-check.result }}" != "success" ]; then
            all_passed=false
          fi
          
          if [ "${{ needs.game-run.result }}" != "success" ]; then
            all_passed=false
          fi
          
          if [ "$all_passed" == "true" ]; then
            echo "üéâ ALL CHECKS PASSED! Game is running successfully!"
            echo "üì∏ Screenshot: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts"
            exit 0
          else
            echo "‚ùå Some checks failed. Please check the workflow logs."
            exit 1
          fi
