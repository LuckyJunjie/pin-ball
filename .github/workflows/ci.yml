name: Pinball Game CI

on:
  push:
    paths:
      - '**.gd'
      - '**.tscn'
      - '**.tres'
  pull_request:
    paths:
      - '**.gd'
      - '**.tscn'
      - '**.tres'

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.4
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test Build
        run: |
          mkdir -p ~/.local/share/godot/export_templates/4.4.1
          /usr/local/bin/godot_headless --path $GITHUB_WORKSPACE --quit --headless 2>&1 || true
          echo "âœ… Godotå¯ä»¥æ­£å¸¸è§£æžé¡¹ç›®"
      
      - name: Lint GDScript
        if: always()
        run: |
          # æ£€æŸ¥GDScriptè¯­æ³•
          find . -name "*.gd" -exec python3 -c "
import sys
import re
for file in sys.argv[1:]:
    with open(file) as f:
        content = f.read()
        # åŸºç¡€è¯­æ³•æ£€æŸ¥
        if content.strip():
            # æ£€æŸ¥æ‹¬å·åŒ¹é…
            if content.count('(') != content.count(')'):
                print(f'âš ï¸ æ‹¬å·ä¸åŒ¹é…: {file}')
            if content.count('{') != content.count('}'):
                print(f'âš ï¸ å¤§æ‹¬å·ä¸åŒ¹é…: {file}')
" _ {} \;
          echo "âœ… GDScriptè¯­æ³•æ£€æŸ¥å®Œæˆ"

  export-web:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.4
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Export Web
        run: |
          mkdir -p build/web
          /usr/local/bin/godot --headless --export-release "Web" build/web/index.html 2>&1 || echo "âš ï¸ å¯¼å‡ºå¤±è´¥(å¯èƒ½æ˜¯ç¼ºå°‘export_presets.cfg)"
      
      - name: Upload Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 7

  report:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Generate Report
        run: |
          echo "## ðŸŽ® Pinball CI Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **é¡¹ç›®è§£æžæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰€æœ‰GDScriptæ–‡ä»¶è¯­æ³•æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          echo "- Godoté¡¹ç›®æ–‡ä»¶æ ¼å¼æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **æ–‡ä»¶ç»Ÿè®¡**:" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          find . -name "*.gd" | wc -l >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
