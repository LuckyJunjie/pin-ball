name: Pinball Godot CI/CD

on:
  push:
    branches: [main]
    paths:
      - '**.gd'
      - '**.tscn'
      - '**.tres'
      - '**.cfg'
  pull_request:
    paths:
      - '**.gd'
      - '**.tscn'
      - '**.tres'
      - '**.cfg'
  workflow_dispatch:

jobs:
  # Job 1: Quick Syntax Check
  syntax-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: GDScript Syntax Check
        run: |
          echo "üìù Checking GDScript syntax..."
          
          # Count files
          script_count=$(find . -name "*.gd" | wc -l)
          scene_count=$(find . -name "*.tscn" | wc -l)
          echo "   Scripts: $script_count"
          echo "   Scenes: $scene_count"
          
          # Check for common issues
          error_count=0
          
          for file in $(find . -name "*.gd" -type f); do
            # Check for balanced parentheses
            open_parens=$(grep -o '(' "$file" | wc -l)
            close_parens=$(grep -o ')' "$file" | wc -l)
            if [ "$open_parens" != "$close_parens" ]; then
              echo "‚ö†Ô∏è  Unbalanced parentheses: $file"
              error_count=$((error_count + 1))
            fi
            
            # Check for unclosed braces
            open_braces=$(grep -o '{' "$file" | wc -l)
            close_braces=$(grep -o '}' "$file" | wc -l)
            if [ "$open_braces" != "$close_braces" ]; then
              echo "‚ö†Ô∏è  Unbalanced braces: $file"
              error_count=$((error_count + 1))
            fi
          done
          
          if [ $error_count -eq 0 ]; then
            echo "‚úÖ All scripts passed syntax check!"
            exit 0
          else
            echo "‚ùå Found $error_count issues"
            exit 1
          fi

  # Job 2: Project Structure Check
  project-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check Project Structure
        run: |
          echo "üìÅ Checking project structure..."
          
          # Check required files
          [ -f "project.godot" ] && echo "‚úÖ project.godot exists" || { echo "‚ùå project.godot missing"; exit 1; }
          
          # Count files
          scripts=$(find . -name "*.gd" | wc -l)
          scenes=$(find . -name "*.tscn" | wc -l)
          resources=$(find . -name "*.tres" | wc -l)
          
          echo "   Scripts: $scripts"
          echo "   Scenes: $scenes"
          echo "   Resources: $resources"
          
          if [ $scripts -gt 0 ]; then
            echo "‚úÖ Project structure valid"
          else
            echo "‚ùå No scripts found"
            exit 1
          fi

  # Job 3: Summary
  summary:
    runs-on: ubuntu-latest
    needs: [syntax-check, project-check]
    if: always()
    steps:
      - name: Generate Report
        run: |
          echo "# üéÆ Pinball CI/CD Test Report" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check syntax result
          if [ "${{ needs.syntax-check.result }}" == "success" ]; then
            echo "‚úÖ **Syntax Check:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Syntax Check:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check project check result
          if [ "${{ needs.project-check.result }}" == "success" ]; then
            echo "‚úÖ **Project Check:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Project Check:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìÅ Project Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "Scripts: $(find . -name '*.gd' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "Scenes: $(find . -name '*.tscn' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "Resources: $(find . -name '*.tres' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Print summary
          cat $GITHUB_STEP_SUMMARY

  # Job 4: Final Status
  status:
    runs-on: ubuntu-latest
    needs: [syntax-check, project-check]
    if: always()
    steps:
      - name: Print Final Status
        run: |
          if [ "${{ needs.syntax-check.result }}" == "success" ] && [ "${{ needs.project-check.result }}" == "success" ]; then
            echo "üéâ All checks passed!"
            exit 0
          else
            echo "‚ùå Some checks failed. Please check the workflow logs."
            exit 1
          fi
