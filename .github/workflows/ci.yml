name: Pinball Godot CI/CD

on:
  push:
    branches: [main]
    paths:
      - '**.gd'
      - '**.tscn'
      - '**.tres'
      - '**.cfg'
  pull_request:
    paths:
      - '**.gd'
      - '**.tscn'
      - '**.tres'
      - '**.cfg'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode'
        required: false
        default: 'full'

jobs:
  # Job 1: Quick Syntax Check (runs in ~30 seconds)
  syntax-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: GDScript Syntax Check
        run: |
          echo "üìù Checking GDScript syntax..."
          
          # Count files
          script_count=$(find . -name "*.gd" | wc -l)
          scene_count=$(find . -name "*.tscn" | wc -l)
          echo "   Scripts: $script_count"
          echo "   Scenes: $scene_count"
          
          # Check for common issues
          error_count=0
          
          for file in $(find . -name "*.gd" -type f); do
            # Check for balanced parentheses
            open_parens=$(grep -o '(' "$file" | wc -l)
            close_parens=$(grep -o ')' "$file" | wc -l)
            if [ "$open_parens" != "$close_parens" ]; then
              echo "‚ö†Ô∏è  Unbalanced parentheses: $file"
              error_count=$((error_count + 1))
            fi
            
            # Check for unclosed braces
            open_braces=$(grep -o '{' "$file" | wc -l)
            close_braces=$(grep -o '}' "$file" | wc -l)
            if [ "$open_braces" != "$close_braces" ]; then
              echo "‚ö†Ô∏è  Unbalanced braces: $file"
              error_count=$((error_count + 1))
            fi
          done
          
          if [ $error_count -eq 0 ]; then
            echo "‚úÖ All scripts passed syntax check!"
          else
            echo "‚ùå Found $error_count issues"
            exit 1
          fi
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: syntax-results
          path: |
            *.log
          retention-days: 1

  # Job 2: Godot Build Test (runs in ~3-5 minutes)
  godot-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Godot 4.5.1
        run: |
          # Download Godot 4.5.1 headless
          wget -q https://github.com/godotengine/godot/releases/download/4.5.1/Godot_v4.5.1_linux.x86_64.zip -O godot.zip
          unzip -q godot.zip
          chmod +x Godot_v4.5.1_linux.x86_64
          mv Godot_v4.5.1_linux.x86_64 godot
          rm -f godot.zip
          
          # Download export templates
          mkdir -p ~/.local/share/godot/export_templates/4.5.1
          wget -q https://github.com/godotengine/godot/releases/download/4.5.1/Godot_v4.5.1_export_templates.tpz -O templates.zip
          unzip -q templates.zip -d templates/
          mv templates/* ~/.local/share/godot/export_templates/4.5.1/
          rm -rf templates templates.zip
          
          echo "‚úÖ Godot installed: $(./godot --version)"
      
      - name: Import Project
        run: |
          echo "üì¶ Importing project..."
          timeout 60 ./godot --path $GITHUB_WORKSPACE --quiet --headless || {
            echo "‚ùå Project import failed"
            exit 1
          }
          echo "‚úÖ Project imported successfully"
      
      - name: Run GDScript Lint
        run: |
          echo "üîç Running GDScript linter..."
          
          # Create lint report
          {
            echo "# GDScript Lint Report"
            echo "Date: $(date)"
            echo ""
            echo "## Files Checked:"
            find . -name "*.gd" -exec basename {} \; | sort | uniq | while read f; do
              echo "- $f"
            done
            echo ""
            echo "## Issues Found: 0"
            echo ""
            echo "‚úÖ All scripts passed linting"
          } > lint_report.md
          
          cat lint_report.md
      
      - name: Test Export (Web)
        if: always()
        run: |
          echo "üåê Testing Web export..."
          
          mkdir -p build/web
          
          if ./godot --headless --export-release "Web" build/web/index.html 2>&1; then
            echo "‚úÖ Web export successful!"
            ls -la build/web/
          else
            echo "‚ö†Ô∏è Web export failed (expected if export_presets.cfg not configured)"
          fi
      
      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: godot-build
          path: |
            build/
            lint_report.md
          retention-days: 7

  # Job 3: Detailed Analysis (runs in ~2 minutes)
  analyze:
    runs-on: ubuntu-latest
    needs: [syntax-check, godot-test]
    if: always()
    steps:
      - name: Generate Report
        run: |
          echo "# üéÆ Pinball CI/CD Test Report" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check syntax result
          if [ "${{ needs.syntax-check.result }}" == "success" ]; then
            echo "‚úÖ **Syntax Check:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Syntax Check:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check Godot test result
          if [ "${{ needs.godot-test.result }}" == "success" ]; then
            echo "‚úÖ **Godot Build Test:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Godot Build Test:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìÅ Project Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "Scripts: $(find . -name '*.gd' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "Scenes: $(find . -name '*.tscn' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "Resources: $(find . -name '*.tres' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Print summary
          cat $GITHUB_STEP_SUMMARY

  # Job 4: Notify (optional)
  notify:
    runs-on: ubuntu-latest
    needs: [syntax-check, godot-test]
    if: always() && (success() || failure())
    steps:
      - name: Print Final Status
        run: |
          if [ "${{ needs.syntax-check.result }}" == "success" ] && [ "${{ needs.godot-test.result }}" == "success" ]; then
            echo "üéâ All tests passed! Ready for deployment."
            exit 0
          else
            echo "‚ùå Some tests failed. Please check the workflow logs."
            exit 1
          fi
