# Pinball v4.0 - Gap Analysis and Requirements Specification

## Executive Summary

Based on analysis of the current Godot implementation and Flutter I/O Pinball reference, this document identifies gaps and provides comprehensive requirements for completing v4.0 implementation. The current v4.0 work is partially implemented but requires completion of core gameplay zones, state management integration, and UI/UX parity.

## 1. Current State Assessment

### 1.1 What Exists (v4.0 Implementation)
- **Core Architecture**: `GameManagerV4.gd`, `BackboxManagerV4.gd`, `MainV4.tscn`, `MainMenuV4.tscn`
- **Basic Systems**: Camera focusing behavior, score management, round system
- **Partial Components**: DrainV4, SkillShotV4, RampV4, UIV4 scripts
- **Documentation**: Comprehensive design docs in `design-v4.0/`

### 1.2 What's Missing (Critical Gaps)
- **Game Zones**: Android Acres, Dino Desert, Google Gallery, Flutter Forest, Sparky Scorch zones not implemented
- **Bonus Systems**: Google Word spelling, Dash Nest completion, bonus ball spawning
- **Multiplier System**: Ramp-based multiplier progression (every 5 hits)
- **Multiball Indicators**: Visual feedback for bonus activation
- **Character Themes**: Four character themes (Sparky, Dino, Dash, Android) with assets
- **Backbox Flow**: Complete leaderboard, initials input, share functionality
- **Asset Integration**: Missing Flutter assets for zones and components

## 2. Architectural Comparison: Flutter BLoC vs Godot

### 2.1 State Management Patterns
| **Flutter (BLoC)** | **Godot (Current)** | **Godot v4.0 Target** |
|-------------------|-------------------|---------------------|
| GameBloc (GameState) | GameManager.gd (v1-3) | GameManagerV4.gd (autoload) |
| StartGameBloc | MainMenu.gd | MainMenuV4.gd + state machine |
| BackboxBloc | Not implemented | BackboxManagerV4.gd |
| Event-driven updates | Signal-based | Signal-based with state enums |
| Immutable state | Mutable variables | Mutable with signal emission |

### 2.2 Key Architectural Gaps
1. **State Isolation**: Flutter uses separate BLoCs; Godot mixes concerns in GameManager
2. **Event System**: Flutter has structured events; Godot uses ad-hoc signals
3. **Dependency Injection**: Flutter uses providers; Godot uses autoload/singletons
4. **Testability**: BLoC enables unit testing; Godot signals harder to test

## 3. Feature Gap Analysis

### 3.1 Core Gameplay Systems
| **Feature** | **Flutter Implementation** | **Godot v4.0 Status** | **Priority** |
|-------------|--------------------------|----------------------|-------------|
| Round System | 3 rounds, multiplier reset | ✅ Implemented | High |
| Scoring | Round + total score | ✅ Implemented | High |
| Multiplier (1-6) | Ramp-based (every 5 hits) | ❌ Missing ramp tracking | High |
| Bonus System | 5 bonuses (googleWord, dashNest, etc.) | ❌ Partial (enum defined) | High |
| Bonus Ball | 5s delay after googleWord/dashNest | ✅ Timer implemented | Medium |

### 3.2 Game Zones (Critical Missing)
| **Zone** | **Components** | **Status** | **Priority** |
|----------|---------------|-----------|-------------|
| Android Acres | SpaceshipRamp, AndroidBumpers, Spaceship | ❌ Not implemented | High |
| Dino Desert | ChromeDino, DinoWalls, Slingshots | ❌ Not implemented | High |
| Google Gallery | GoogleWord, Rollovers (5k each) | ❌ Not implemented | High |
| Flutter Forest | Signpost, Dash bumpers, Dash animatronic | ❌ Not implemented | High |
| Sparky Scorch | Sparky bumpers, computer, animatronic | ❌ Not implemented | High |
| Multipliers | x2-x6 visual indicators | ❌ Not implemented | Medium |
| Multiballs | A-D indicator lights | ❌ Not implemented | Medium |

### 3.3 UI/UX Systems
| **System** | **Flutter** | **Godot v4.0 Status** | **Priority** |
|------------|------------|----------------------|-------------|
| Start Flow | Initial → Character → HowToPlay → Play | ✅ MainMenuV4 exists | High |
| Character Select | 4 themes with preview | ❌ Missing theme assets | High |
| How to Play | Instructions screen | ❌ Not implemented | Medium |
| Backbox Display | Leaderboard, initials, game over, share | ✅ BackboxManagerV4 partial | High |
| HUD | Score, multiplier, ball count | ✅ UIV4 partial | Medium |
| Camera Focus | Zoom/position per game state | ✅ Implemented | High |

### 3.4 Asset Requirements
| **Asset Category** | **Flutter Source** | **Godot Status** | **Priority** |
|-------------------|-------------------|-----------------|-------------|
| Character Themes | `pinball_theme/assets/images/{theme}/` | ❌ Missing ball variants | High |
| Zone Components | `pinball_components/assets/images/` | ❌ Partial (v3.0 assets) | High |
| Backbox Assets | Marquee, panel textures | ❌ Missing | Medium |
| Score Popups | 5k, 20k, 200k, 1M sprites | ❌ Missing | Low |
| Sound Effects | `pinball_audio/` MP3s | ✅ v3.0 sounds exist | Medium |

## 4. Comprehensive v4.0 Requirements

### 4.1 Functional Requirements (FR)

**FR-4.1 Game Core**
- FR-4.1.1: Game shall maintain 3 rounds per game
- FR-4.1.2: Multiplier shall reset to 1 after each round loss
- FR-4.1.3: Score shall be calculated as: totalScore + (roundScore × multiplier)
- FR-4.1.4: Maximum score shall be 9,999,999,999

**FR-4.2 Game Zones**
- FR-4.2.1: Android Acres shall include spaceship ramp, 3 bumpers, and spaceship target
- FR-4.2.2: Dino Desert shall include Chrome Dino mouth target and slingshots
- FR-4.2.3: Google Gallery shall include 6-letter word and left/right rollovers
- FR-4.2.4: Flutter Forest shall include signpost and 3 Dash bumpers
- FR-4.2.5: Sparky Scorch shall include 3 Sparky bumpers and computer target

**FR-4.3 Bonus System**
- FR-4.3.1: Completing "GOOGLE" word shall activate googleWord bonus
- FR-4.3.2: Lighting all 3 Dash bumpers shall activate dashNest bonus
- FR-4.3.3: Bonus activation shall trigger bonus ball after 5-second delay
- FR-4.3.4: Five bonus types shall be supported: googleWord, dashNest, sparkyTurboCharge, dinoChomp, androidSpaceship

**FR-4.4 Multiplier System**
- FR-4.4.1: Multiplier shall increase from 1 to 6 maximum
- FR-4.4.2: Multiplier shall increase every 5 ramp hits in Android Acres
- FR-4.4.3: Visual indicators (x2-x6) shall light sequentially

**FR-4.5 UI/UX Flow**
- FR-4.5.1: Start flow shall be: Initial → Character Select → How to Play → Game
- FR-4.5.2: Character selection shall support 4 themes: Sparky, Dino, Dash, Android
- FR-4.5.3: Backbox shall display: Leaderboard → Initials Input → Game Over → Share
- FR-4.5.4: Camera shall zoom/position based on game state (waiting, playing, game over)

### 4.2 Technical Requirements (TR)

**TR-4.1 Architecture**
- TR-4.1.1: GameManagerV4 shall be autoload singleton managing game state
- TR-4.1.2: BackboxManagerV4 shall manage backbox display states
- TR-4.1.3: Zone scripts shall emit signals to GameManagerV4 for scoring/bonuses
- TR-4.1.4: Signal-based communication shall replace direct method calls

**TR-4.2 Asset Management**
- TR-4.2.1: Character themes shall be loaded from `assets/sprites/v4.0/{theme}/`
- TR-4.2.2: Zone assets shall be organized by zone (android/, dino/, google/, etc.)
- TR-4.2.3: Sound effects shall support both WAV and OGG formats

**TR-4.3 Physics & Performance**
- TR-4.3.1: Physics shall use Godot 4.x RigidBody2D with realistic pinball values
- TR-4.3.2: Game shall maintain 60 FPS on target platforms
- TR-4.3.3: Ball count shall be limited to prevent performance issues

## 5. Implementation Priority Matrix

### Priority 1 (Critical - Blocking v4.0 Completion)
1. **Game Zone Implementation** - All 5 zones with scoring/bonus logic
2. **Bonus System Completion** - googleWord and dashNest tracking
3. **Character Theme Integration** - 4 themes with assets
4. **Backbox Flow Completion** - Leaderboard to share workflow

### Priority 2 (High - Core Gameplay)
1. **Multiplier System** - Ramp hit tracking and visual indicators
2. **Asset Integration** - Missing Flutter assets for zones
3. **Sound System** - Zone-specific sound effects
4. **UI Polish** - HUD completion and visual feedback

### Priority 3 (Medium - Polish)
1. **Multiball Indicators** - Visual feedback for bonuses
2. **Score Popups** - Animated score displays
3. **Particle Effects** - Enhanced visual feedback
4. **Mobile Controls** - Touch input optimization

### Priority 4 (Low - Enhancements)
1. **Local Leaderboard** - Persistent score storage
2. **Share Functionality** - Score sharing implementation
3. **Settings Menu** - Audio/visual settings
4. **Tutorial System** - Enhanced how-to-play

## 6. Success Metrics

### 6.1 Feature Completeness
- ✅ All 5 game zones implemented and functional
- ✅ Bonus system with 5 bonus types working
- ✅ Multiplier system (1-6) with visual feedback
- ✅ Complete start flow (character select → how to play → game)
- ✅ Backbox display states (leaderboard → initials → share)

### 6.2 Performance Targets
- ≥ 60 FPS during gameplay
- < 100ms loading time between scenes
- Memory usage < 256MB on mobile devices

### 6.3 Parity Metrics
- 95%+ feature parity with Flutter I/O Pinball
- Identical scoring and bonus mechanics
- Visual similarity to Flutter reference
- Comparable gameplay feel and flow

## 7. Next Steps

1. **Create detailed implementation plan** for each game zone
2. **Asset acquisition/creation** for missing visual elements
3. **Zone-by-zone implementation** starting with Android Acres
4. **Integration testing** of zone interactions
5. **UI/UX polish** for complete Flutter parity
6. **Performance optimization** and bug fixing

---

*Document Version: 1.0*  
*Last Updated: 2026-01-31*  
*Based on analysis of: Current Godot implementation v1-3, v4.0 partial work, Flutter I/O Pinball reference*