# Fix Plan - 2026-02-01

## 1. Legacy/Unused File Cleanup

### Remove (useless)
- `scripts/DeepSeekAPI.gd` - External API, not used by game
- `scripts/DeepSeekAPIExample.gd` - Example for above

### Move to archived/legacy
- Scenes: Main.tscn, MainMenu.tscn, ShopScene.tscn (v1-v3, replaced by MainV4/MainMenuV4)
- Scenes: Obstacle.tscn, Hold.tscn, BallQueue.tscn (used by Main.tscn only)
- Scripts used only by above: GameManager.gd, BallQueue.gd, Obstacle.gd, Hold.gd, MainMenuManager.gd, ShopManager.gd, UI.gd, ObstacleSpawner.gd, MultiballManager.gd, MultiballTarget.gd

### Keep (used by v4.0)
- Ball.gd, Flipper.gd, Launcher.gd, SoundManager.gd - shared with MainV4
- Ramp.gd, SkillShot.gd - v3 but may have references; RampV4/SkillShotV4 are v4

## 2. Game Playability Fixes

### Root cause analysis
1. **Ball falls directly**: Ball spawns at (400,535) but Launcher uses launcher_position=(720,400) - ball never detected by Launcher
2. **Launcher never receives ball**: launcher_position is wrong; Launcher._check_ball_arrival looks at wrong coordinates
3. **DrainV4 destroys balls**: queue_free() conflicts with BallPoolV4 which expects to return balls
4. **Zone duplication**: _load_game_zones() adds zones on top of scene's zones = 2x zones
5. **Ball spawn timing**: start_game() runs before BallPoolV4._initialize_ball_pool() (deferred)

### Fixes

| Issue | Fix |
|-------|-----|
| Launcher position | Set launcher_position = global_position in Launcher._ready for v4 context |
| Drain vs BallPool | DrainV4: return ball to pool (if pool) instead of queue_free; then check round_lost |
| Zone duplication | Remove _load_game_zones() - scene already has zones |
| Ball spawn timing | MainV4: call_deferred for start_game so BallPool initializes first |
| GameManager-Launcher | Wire GameManager to notify Launcher when ball spawns, OR fix Launcher position so _check_ball_arrival works |

### Status: Implemented
### Update (empty playfield fix): Flipper/Launcher textures were missing. Fixed by using Flutter pinball parity assets from /Users/junjiepan/github/pinball: flipper/left.png, flipper/right.png; plunger/plunger.png; launch_ramp/ramp.png; baseboard for launcher base. Flipper.gd sets texture by side in _ready.
- Launcher: launcher_position set from global_position in _ready; _check_ball_arrival accepts frozen balls
- DrainV4: returns ball to BallPoolV4 instead of queue_free
- Zone duplication: removed _load_game_zones() 
- start_game: deferred so BallPoolV4 initializes first
- Ball spawn: kept frozen until Launcher launches
- Legacy: DeepSeekAPI* removed; Main/MainMenu/Shop/Obstacle/Hold/BallQueue + related scripts moved to archived/legacy

### Flippers/Ramp
- Flippers: Left (340, 518), Right (424, 518)
- Launcher: RIGHT SIDE (605, 518) per Flutter – channel with ball, plunger visible
- Ramp at (180,180), scale 0.5; Playfield ramp + LaunchRamp sprite in Launcher scene

### Flutter controls parity (2026-02-01)
- **Launch**: Down Arrow, Space, or S – HOLD to pull plunger, RELEASE to launch (removed ui_down exclusion)
- **Flippers**: Left arrow or A (left), Right arrow or D (right)

### Ball/launcher/ramp/drain layout (2026-02-01)
- **Ball size**: radius 5, visual scale 0.5 (was 8/1) - Flutter-relative sizing
- **Ball position**: launcher + (-3, -35) so ball aligns in channel above plunger
- **Duplicate ramp**: Playfield/Ramp hidden; only Launcher ramp + Android zone ramp
- **Drain**: y=660 (Flutter bottom 71.9 → 300+359.5)
- **Launch forces**: 400–800 for smaller ball

### Launcher/ball fixes (2026-02-01) - 16 launchers, ball launch
- **16 launchers**: plunger.png is 20-frame sprite sheet; Launcher.gd sets region_rect to show 1 frame
- **Railings removed**: background_railing/foreground_railing caused rod duplication; removed from Launcher
- **Ball launch**: GameManager calls launcher.set_ball(ball) after spawn; ball positioned above plunger
- **Duplicate zones**: DinoDesert, FlutterForest, SparkyScorch, GoogleGallery set visible=false; AndroidAcres only

### Flutter parity fixes (2026-02-01) - ball, red/blue items
- **Ball**: Fixed spawn with explicit visible=true; Ball texture→android/ball.png (ball.png missing)
- **Red items (now visible)**: Android bumpers use lit.png; Spaceship (UFO) + ramp sprites in AndroidAcres; Kickers (green paddles) at (286,426) and (514,426)
- **Launcher channel**: background_railing, foreground_railing, ramp, baseboard/right
- **KickerV4**: 5000 pts, obstacle_hit signal

### Launcher/visuals parity (2026-02-01)
- **Launcher**: Flutter assets – plunger.png, rocket.png, launch_ramp/ramp.png, baseboard/right.png (right side)
- **Removed**: ChargeMeter % display (Flutter has no %)
- **Playfield Ramp**: android/ramp/main.png (points ramp, distinct from launcher)
- **SkillShot**: skill_shot/pin.png visual added
- **Ball pool**: Explicit init in MainV4._ready before deferred start_game
- **Camera**: visible_height 580 for tighter view
- CoordinateConverterV4 autoload for Flutter→Godot position/impulse conversion

### Flutter→Godot adaptations (2026-02-01)
- Positions use CoordinateConverterV4; flipper values from FLUTTER-LAYOUT-AND-ASSETS.md
- Bonus ball spawn/impulse via flutter_to_godot, flutter_impulse_to_godot
- Camera: fixed center (400,300), visible height 650 (Flutter formulas caused off-screen)
- Physics layers: Ball(1), Flippers(2), Walls(4), Obstacles(8) - Ball mask 14 = collides with all
- Flipper collision_mask=1 (ball) set in Flipper._ready - correct
